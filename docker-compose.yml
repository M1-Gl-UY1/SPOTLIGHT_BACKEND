version: '3.9'

networks:
  spotlight-net:
    driver: bridge

volumes:
  mysql_offre_data:
  mysql_signal_moder_data:
  catalogue_prestation_db_data:
  postgres_data:

services:

  # ====================================================
  # 1. INFRASTRUCTURE & BASES DE DONNÉES
  # ====================================================
  mongodb:
    image: mongo:latest
    container_name: mongodb
    ports:
      - "27017:27017"
    networks:
      - spotlight-net

  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "61613:61613"
      - "15672:15672"
    command: /bin/bash -c "rabbitmq-plugins enable rabbitmq_stomp && rabbitmq-server"
    networks:
      - spotlight-net

  mysql_offre_prestaion_db:
    image: mysql:8.0
    container_name: mysql_offre_prestaion_db
    #restart always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: spotlight_offres_db
    ports:
      - "3309:3306"
    volumes:
      - mysql_offre_data:/var/lib/mysql
    networks:
      - spotlight-net

  mysql-signal-moder-service:
    image: mysql:8.0
    container_name: mysql-signal-moder-service
    #restart always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: moderation_db
      MYSQL_USER: spotlight_user
      MYSQL_PASSWORD: spotlight_password
    ports:
      - "3308:3306"
    volumes:
      - mysql_signal_moder_data:/var/lib/mysql
    networks:
      - spotlight-net

  catalogue-prestation-db:
    image: mysql:8.0
    container_name: catalogue_prestation_db
    #restart always
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: catalogue_prestation_db
      MYSQL_USER: catalogue_user
      MYSQL_PASSWORD: catalogue_password
    ports:
      - "3310:3306"
    volumes:
      - catalogue_prestation_db_data:/var/lib/mysql
    networks:
      - spotlight-net

  postgres:
    image: postgres:15-alpine
    container_name: postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-postgres.sh:/docker-entrypoint-initdb.d/init-postgres.sh
    networks:
      - spotlight-net
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 15

  # ====================================================
  # 2. SOCLE SPRING CLOUD
  # ====================================================
  config-service:
    build: ./config-service
    container_name: config-service
    #restart on-failure
    ports:
      - "8888:8888"
    environment:
      SPRING_CLOUD_CONFIG_SERVER_GIT_URI: https://github.com/M1-Gl-UY1/config-repo-spotlight.git
    networks:
      - spotlight-net

  registry-service:
    build: ./registry-service
    container_name: registry-service
    #restart on-failure
    ports:
      - "8761:8761"
    environment:
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-service:8888/
      SPRING_CLOUD_CONFIG_URI: http://config-service:8888
    depends_on:
      - config-service
    networks:
      - spotlight-net

  proxy-service:
    build: ./proxy-service
    container_name: proxy-service
    #restart on-failure
    ports:
      - "8080:8080"
    environment:
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-service:8888/
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-service:8761/eureka/
    depends_on:
      - registry-service
      - config-service
    networks:
      - spotlight-net

  # ====================================================
  # 3. MICROSERVICES MÉTIERS
  # ====================================================
  offerandprestation:
    build: ./offerandprestation
    container_name: offerandprestation
    #restart on-failure
    ports:
      - "8093:8093"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql_offre_prestaion_db:3306/spotlight_offres_db?createDatabaseIfNotExist=true&allowPublicKeyRetrieval=true&useSSL=false
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-service:8761/eureka/
      FILE_UPLOAD_DIR: /uploads-spotlight
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-service:8888/
    volumes:
      - ./uploads-spotlight:/uploads-spotlight
    depends_on:
      - mysql_offre_prestaion_db
      - registry-service
      - config-service
    networks:
      - spotlight-net

  signal-moder-service:
    build: ./signal-moder-service
    container_name: signal-moder-service
    #restart on-failure
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql-signal-moder-service:3306/moderation_db?createDatabaseIfNotExist=true&allowPublicKeyRetrieval=true&useSSL=false
      SPRING_DATASOURCE_USERNAME: spotlight_user
      SPRING_DATASOURCE_PASSWORD: spotlight_password
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-service:8761/eureka/
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-service:8888/
    depends_on:
      - mysql-signal-moder-service
      - registry-service
      - config-service
    networks:
      - spotlight-net

  chat-service:
    build: ./chat
    container_name: chat-service
    #restart on-failure
    environment:
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-service:8888/
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-service:8761/eureka/
      SPRING_APPLICATION_NAME: chat-service
      # Ancienne variable (à supprimer ou ignorer) : MONGO_HOST: mongodb

      # Nouvelle variable recommandée pour Spring Data MongoDB:
      SPRING_DATA_MONGODB_URI: mongodb://mongodb:27017/chatdb  # Remplacez 'chatdb' par le nom de votre base de données si nécessaire.

      RABBIT_HOST: rabbitmq
    depends_on:
      - mongodb
      - rabbitmq
      - registry-service
      - config-service
    networks:
      - spotlight-net

  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: user-service
    restart: unless-stopped
    depends_on:
      registry-service:
        condition: service_healthy
      postgres:
        condition: service_healthy
    environment:
      # Configuration pour le loader (config-loader.js)
      - CONFIG_SERVER_URL=http://config-service:8888/user-service/default

      # Configuration pour Eureka (server.js)
      - EUREKA_HOST=registry-service
      - EUREKA_PORT=8761
      - EUREKA_INSTANCE_HOSTNAME=user-service # CRUCIAL pour que la Gateway le trouve !
      - EUREKA_INSTANCE_IP_ADDRESS=user-service

      # Configuration DB et App
      - PORT=5000
      - PG_HOST=postgres
      - PG_PORT=5432
      - PG_USER=postgres
      - PG_PASSWORD=password
      - PG_DB=talent
      - NODE_ENV=production
    ports:
      - "5000:5000"
    networks:
      - spotlight-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/"] # Adapte le path si besoin (ex: /health)
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s


  catalogue-service-python:
    build: ./spotlight_catalogue_presentation
    container_name: catalogue-service-python
    #restart on-failure
    ports:
      - "8000:8000"
    environment:
      DB_HOST: catalogue-prestation-db
      DB_PORT: 3306
      DB_NAME: catalogue_prestation_db
      DB_USER: catalogue_user
      DB_PASSWORD: catalogue_password
      DEBUG: "True"
      ALLOWED_HOSTS: "*"
      OPENROUTER_API_KEY: "sk-or-v1-TA_NOUVELLE_CLE_ICI"
      EUREKA_SERVER: http://registry-service:8761/eureka/
    depends_on:
      - config-service
      - registry-service
      - catalogue-prestation-db
    networks:
      - spotlight-net
