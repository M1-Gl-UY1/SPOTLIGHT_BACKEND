version: '3.8'

networks:
  spotlight-net:
    driver: bridge

volumes:
  mysql_offre_data:
  mysql_signal_moder_data:
  mysql_signasl_data:
  postgres_data:
  catalogue_prestation_db_data:

services:

  # ===========================
  # MySQL â€” SIGNASL (3309)
  # ===========================
  mysql_offre_prestaion_db:
    image: mysql:8.0
    container_name: mysql_signasl
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: spotlight_offres_db
    ports:
      - "3309:3306"
    volumes:
      - mysql_signasl_data:/var/lib/mysql
    networks:
      - spotlight-net

  # ===========================
  # RabbitMQ
  # ===========================
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
      - "61613:61613"
    command: /bin/bash -c "rabbitmq-plugins enable rabbitmq_stomp && rabbitmq-server"
    networks:
      - spotlight-net

  # ===========================
  # Config Server
  # ===========================
  config-service:
    build: ./config-service
    container_name: config-service
    ports:
      - "8888:8888"
    environment:
      SPRING_CLOUD_CONFIG_SERVER_GIT_URI: https://github.com/M1-Gl-UY1/config-repo-spotlight.git
    networks:
      - spotlight-net

  # ===========================
  # Eureka Registry
  # ===========================
  registry-service:
    build: ./registry-service
    container_name: registry-service
    ports:
      - "8761:8761"
    environment:
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-service:8888/
    depends_on:
      - config-service
    networks:
      - spotlight-net

  # ===========================
  # API Gateway
  # ===========================
  proxy-service:
    build: ./proxy-service
    container_name: proxy-service
    ports:
      - "8080:8080"
    environment:
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-service:8888/
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-service:8761/eureka/
    networks:
      - spotlight-net

  # ===========================
  # Service OFFER
  # ===========================
  offerandprestation:
    build: ./offerandprestation
    container_name: offerandprestation
    restart: always
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql_offre_prestaion_db:3306/spotlight_offres_db?createDatabaseIfNotExist=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-service:8761/eureka/
      FILE_UPLOAD_DIR: /uploads-spotlight
    ports:
      - "8093:8093"
    depends_on:
      - mysql_offre_prestaion_db
      - registry-service
      - config-service
    volumes:
      - ./uploads-spotlight:/uploads-spotlight
    networks:
      - spotlight-net

  # ===========================
  # MongoDB pour CHAT
  # ===========================
  mongodb:
    image: mongo:latest
    container_name: mongodb
    ports:
      - "27017:27017"
    networks:
      - spotlight-net

  # ===========================
  # Chat Service
  # ===========================
  chat-service:
    build: ./chat
    container_name: chat-service
    environment:
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-service:8888/
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-service:8761/eureka/
      MONGO_HOST: mongodb
      RABBIT_HOST: rabbitmq
    depends_on:
      - mongodb
      - rabbitmq
      - registry-service
      - config-service
    networks:
      - spotlight-net

  # ===========================
  # MySQL MODERATION (3308)
  # ===========================
  mysql-signal-moder-service:
    image: mysql:8.0
    container_name: mysql-signal-moder-service
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: moderation_db
      MYSQL_USER: spotlight_user
      MYSQL_PASSWORD: spotlight_password
    ports:
      - "3308:3306"
    volumes:
      - mysql_signal_moder_data:/var/lib/mysql
    networks:
      - spotlight-net

  # ===========================
  # Signal Moder Service
  # ===========================
  signal-moder-service:
    build: ./signal-moder-service
    container_name: signal-moder-service
    environment:
      SPRING_CONFIG_IMPORT: optional:configserver:http://config-service:8888/
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-service:8761/eureka/
      DB_HOST: mysql-signal-moder-service
      DB_NAME: moderation_db
      DB_USER: spotlight_user
      DB_PASSWORD: spotlight_password
    depends_on:
      - mysql-signal-moder-service
      - registry-service
      - config-service
    networks:
      - spotlight-net

  # ===========================
  # PostgreSQL
  # ===========================
  postgres:
    image: postgres:15-alpine
    container_name: postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-postgres.sh:/docker-entrypoint-initdb.d/init-postgres.sh
    networks:
      - spotlight-net

  # ===========================
  # User Service (Node.js)
  # ===========================
  user-service:
    build: ./user-service
    container_name: user-service
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASS: postgres
      DB_NAME: user_db
      EUREKA_HOST: registry-service
      EUREKA_PORT: 8761
      PORT: 3000
    depends_on:
      - postgres
      - registry-service
      - config-service
    networks:
      - spotlight-net

  # ==============================#
  # Catalogue presetation Service #
  # ==============================#
  catalogue-prestation-db:
    image: mysql:8.0
    container_name: catalogue_prestation_db
    restart: always
    environment:
      MYSQL_DATABASE: catalogue_prestation_db
      MYSQL_USER: catalogue_user
      MYSQL_PASSWORD: catalogue_password
      MYSQL_ROOT_PASSWORD: root_password
    ports:
      - "3310:3306"
    volumes:
      - catalogue_prestation_db_data:/var/lib/mysql
    networks:
      - spotlight-net
  # ===========================
  # Catalogue Python
  # ===========================

  catalogue-service-python:
    build: ./spotlight_catalogue_presentation
    container_name: catalogue-service-python
    environment:
      DATABASE_HOST: catalogue-prestation-db
      DATABASE_PORT: 3306
      DATABASE_NAME: catalogue_prestation_db
      DATABASE_USER: catalogue_user
      DATABASE_PASSWORD: catalogue_password
      EUREKA_SERVER: http://registry-service:8761/eureka
    depends_on:
      - registry-service
      - catalogue-prestation-db
    networks:
      - spotlight-net