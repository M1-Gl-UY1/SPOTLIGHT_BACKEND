version: '3.8'

services:
  # --- INFRASTRUCTURE ---
  
  mongodb:
    image: mongo:latest
    container_name: mongodb
    ports:
      - "27017:27017"

  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
      - "61613:61613" # STOMP
    command: /bin/bash -c "rabbitmq-plugins enable rabbitmq_stomp && rabbitmq-server"

  # --- MICROSERVICES DE BASE ---

  discovery-service:
    build: ./discovery-service # Chemin vers le dossier du projet Eureka
    container_name: discovery-service
    ports:
      - "8761:8761"
    environment:
      - SPRING_PROFILES_ACTIVE=docker

  gateway-service:
    build: ./gateway-service
    container_name: gateway-service
    ports:
      - "80:8080" # On expose la gateway sur le port 80 (standard web)
    environment:
      - EUREKA_URI=http://discovery-service:8761/eureka/
    depends_on:
      - discovery-service

  # --- TON CHAT SERVICE (JAVA) ---
  
  chat-service:
    build: ./chat-service # Le dossier où on a mis le Dockerfile à l'étape 1
    container_name: chat-service
    environment:
      - MONGO_HOST=mongodb            # Nom du service docker défini plus haut
      - RABBIT_HOST=rabbitmq          # Nom du service docker
      - EUREKA_URI=http://discovery-service:8761/eureka/
    depends_on:
      - mongodb
      - rabbitmq
      - discovery-service

  # --- EXEMPLE AUTRES SERVICES (Django/Node) ---
  
  user-service-django:
    build: ./user-service
    container_name: user-service
    command: python manage.py runserver 0.0.0.0:8000
    environment:
      - DATABASE_URL=postgres://...
      - EUREKA_URL=http://discovery-service:8761/eureka/